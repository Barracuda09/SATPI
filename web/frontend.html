<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="stylesheet.css">

<title>SAT>IP - Frontend info Page</title>

<script src="menu.js"></script>
<script src="loadxmldoc.js"></script>
<script src="postxmldoc.js"></script>
<script src="jquery.min.js"></script>
<script src="bootstrap.min.js"></script>
<script>
	var filename = "streams.xml";
	var autoload = 1;
	var xmlLoaded;

	function myOnkeyPressPost(id, valname, value, event) {
		var key = event.which;
		if (key == 13) {
			changeXMLAndPost(id, valname, value);
		}
	}

	function addTableLineEntry(xmlDoc, name, tagName) {
		var entry =	 "<tr><td>" + name + "</td>";
		var len = xmlDoc.getElementsByTagName("streamindex").length;
		for (en = 0; en < len; en++) {
			entry +=  "<td>";
			var data = xmlDoc.getElementsByTagName("stream" + en)[0];
			var value = data.getElementsByTagName(tagName)[0].childNodes[0].nodeValue;
			entry += value;
			entry +=  "</td>";
		}
		entry += "</tr>";
		return entry;
	}

	function changeXMLAndPost(id, tagName, value) {
		var n = id.lastIndexOf(".") + 1;
		var index = id.substring(n);
		var data = xmlLoaded.getElementsByTagName("stream" + index)[0];
		var input = data.getElementsByTagName(tagName)[0];
		input.getElementsByTagName("value")[0].childNodes[0].nodeValue = value;
		var xmlString = (new XMLSerializer()).serializeToString(xmlLoaded);
		postData(filename, xmlString);
	}

	function addTableLineEntryInput(xmlDoc, name, valname) {
		var entry =	 "<tr><td>" + name + "</td>";
		var len = xmlDoc.getElementsByTagName("streamindex").length;
		for (en = 0; en < len; en++) {
			entry +=  "<td>";
			var data = xmlDoc.getElementsByTagName("stream" + en)[0];
			var input = data.getElementsByTagName(valname)[0];
			var type = input.getElementsByTagName("inputtype")[0].childNodes[0].nodeValue;
			var value = input.getElementsByTagName("value")[0].childNodes[0].nodeValue;
			var id = valname + "." + en
			if (type == "checkbox") {
				if (value == "true") {
					entry += "<input type=\"checkbox\" name=\"" + valname + "\" checked=\"\"";
				} else {
					entry += "<input type=\"checkbox\" name=\"" + valname + "\"";
				}
				entry += "id=\"" + id + "\"";
				entry += "value=\"" + en + "\"";
				entry += "onclick=\"changeXMLAndPost(document.getElementById(id).id, document.getElementById(id).name, document.getElementById(id).checked)\"";
				entry += "/>";
			} else if (type == "number") {
				entry += "<input type=\"number\" name=\"" + valname + "\" value=\"" + value + "\"";
				entry += "id=\"" + id + "\"";
				entry += "min=\"" + input.getElementsByTagName("minvalue")[0].childNodes[0].nodeValue + "\"";
				entry += "max=\"" + input.getElementsByTagName("maxvalue")[0].childNodes[0].nodeValue + "\"";
				entry += "onfocus=\"autoload = 0\" onblur=\"autoload = 1\"";
				entry += "onmousedown=\"document.getElementById(id).focus()\"";
				entry += "onclick=\"changeXMLAndPost(document.getElementById(id).id, document.getElementById(id).name, document.getElementById(id).value)\"";
				entry += "onkeypress=\"myOnkeyPressPost(document.getElementById(id).id, document.getElementById(id).name, document.getElementById(id).value, event)\"";
				entry += "/>";
			}
			entry +=  "</td>";
		}
		entry += "</tr>";
		return entry;
	}

	function buildcontent(xmlDoc) {
		var page = "";
		var streams = xmlDoc.getElementsByTagName("streamindex");
		if (streams.length > 0) {
			page += "<table class=\"table table-bordered table-striped\">";
			page += "<tr class=\"separator\"><th colspan=\"" + (streams.length+1) + "\">Frontend Info</th></tr>";
			page += addTableLineEntry(xmlDoc, "Stream Index", "streamindex");

			page += addTableLineEntry(xmlDoc, "Attached", "attached");
			page += addTableLineEntry(xmlDoc, "Name", "frontendname");
			page += addTableLineEntry(xmlDoc, "Path", "pathname");
			page += addTableLineEntry(xmlDoc, "Freq Range", "freq");
			page += addTableLineEntry(xmlDoc, "Symbol Rate Range", "symbol");

			page += "<tr class=\"separator\"><th colspan=\"" + (streams.length+1) + "\">Stream Info</th></tr>";
			page += addTableLineEntry(xmlDoc, "Owner", "owner");
			page += addTableLineEntry(xmlDoc, "Session ID", "ownerSessionID");
			page += addTableLineEntry(xmlDoc, "RTP packet count", "spc");
			page += addTableLineEntry(xmlDoc, "RTP streamed (MB)", "payload");

			page += "<tr class=\"separator\"><th colspan=\"" + (streams.length+1) + "\">Stream Configuration</th></tr>";
			page += addTableLineEntryInput(xmlDoc, "Repeat DiSEqC", "diseqc_repeat");
			page += addTableLineEntryInput(xmlDoc, "DVR Buffer (Bytes)", "dvrbuffer");
			page += addTableLineEntryInput(xmlDoc, "RTCP Signal Update Freq", "rtcpSignalUpdate");

			page += "<tr class=\"separator\"><th colspan=\"" + (streams.length+1) + "\">Channel Info</th></tr>";
			delsys = addTableLineEntry(xmlDoc, "Delivery System", "delsys");
			page += delsys;
			page += addTableLineEntry(xmlDoc, "Tune Freq", "tunefreq");
			page += addTableLineEntry(xmlDoc, "Modulation", "modulation");
			page += addTableLineEntry(xmlDoc, "Fec", "fec");

			page += addTableLineEntry(xmlDoc, "Symbol Rate", "tunesymbol");
			page += addTableLineEntry(xmlDoc, "Rolloff", "rolloff");
			page += addTableLineEntry(xmlDoc, "Source", "src");
			page += addTableLineEntry(xmlDoc, "Polarization", "pol");

			page += "<tr class=\"separator\"><th colspan=\"" + (streams.length+1) + "\">Monitor Info</th></tr>";
			page += addTableLineEntry(xmlDoc, "Status", "status");
			page += addTableLineEntry(xmlDoc, "Signal Strength", "signal");
			page += addTableLineEntry(xmlDoc, "snr", "snr");
			page += addTableLineEntry(xmlDoc, "ber", "ber");
			page += addTableLineEntry(xmlDoc, "unc", "unc");

			page +=	 "</table><br>";
		}
		return page;
	}
	function updatePage() {
		loadXMLDoc(filename);
	}
	// function called when xml is loaded
	function xmlloaded(xml) {
		if (autoload == 1) {
			xmlLoaded = xml;
			document.getElementById("content").innerHTML = buildcontent(xml);
		}
	}
</script>

</head>
<body>
<div id="menu"></div>

<div class="container-fluid">
	<div class="start">
		<h3>SAT>IP Frontend Info Page</h3>
		<div class="table-responsive">
			<div id="content"></div>

			<script>
				// make menu
				document.getElementById("menu").innerHTML = buildmenu();
				setMenuItemActive("frontend");

				// Call the ajax refresh each refresh_time seconds
				var refresh_time = 2000;
				updatePage();
				setInterval("updatePage()", refresh_time);
			</script>
		</div>
	</div>
</div>

<div class="navbar navbar-default navbar-fixed-bottom">
	<div class="container">
		<p class="navbar-text pull-left">Copyright &#169; 2015 Marc Postema</p>
	</div>
</div>
</body>
</html>
